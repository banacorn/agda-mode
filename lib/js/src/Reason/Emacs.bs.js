// Generated by BUCKLESCRIPT VERSION 4.0.5, PLEASE EDIT WITH CARE
'use strict';

var Path = require("path");
var $$Array = require("bs-platform/lib/js/array.js");
var Block = require("bs-platform/lib/js/block.js");
var $$String = require("bs-platform/lib/js/string.js");
var Js_option = require("bs-platform/lib/js/js_option.js");
var Caml_array = require("bs-platform/lib/js/caml_array.js");
var Caml_format = require("bs-platform/lib/js/caml_format.js");
var Js_primitive = require("bs-platform/lib/js/js_primitive.js");
var Util$AgdaMode = require("./Util.bs.js");

function unindent(lines) {
  var lineStart = (/^\S+/);
  var lineStartIndices = $$Array.map((function (param) {
          return param[1];
        }), lines.map((function (line, index) {
                return /* tuple */[
                        line,
                        index
                      ];
              })).filter((function (param) {
              return lineStart.test(param[0]);
            })));
  return $$Array.map((function (param) {
                return $$String.concat("\n", $$Array.to_list(lines.slice(param[0], param[1])));
              }), lineStartIndices.map((function (index, i) {
                    if (lineStartIndices.length === (i + 1 | 0)) {
                      return /* tuple */[
                              index,
                              lines.length + 1 | 0
                            ];
                    } else {
                      return /* tuple */[
                              index,
                              Caml_array.caml_array_get(lineStartIndices, i + 1 | 0)
                            ];
                    }
                  })));
}

function allGoalsWarningsPreprocess(title, body) {
  var shitpile = unindent(body.split("\n"));
  var hasMetas = Js_option.isSome(Js_primitive.null_to_opt(title.match((/Goals/))));
  var hasWarnings = Js_option.isSome(Js_primitive.null_to_opt(title.match((/Warnings/))));
  var hasErrors = Js_option.isSome(Js_primitive.null_to_opt(title.match((/Errors/))));
  var indexOfWarnings = shitpile.findIndex((function (s) {
          return Js_option.isSome(Js_primitive.null_to_opt(s.slice(5, 13).match((/Warnings/))));
        }));
  var indexOfErrors = shitpile.findIndex((function (s) {
          return Js_option.isSome(Js_primitive.null_to_opt(s.slice(5, 11).match((/Errors/))));
        }));
  if (hasMetas) {
    if (hasWarnings) {
      if (hasErrors) {
        return /* record */Block.record([
                  "metas",
                  "warnings",
                  "errors"
                ], [
                  shitpile.slice(0, indexOfWarnings),
                  shitpile.slice(indexOfWarnings + 1 | 0, indexOfErrors),
                  shitpile.slice(indexOfErrors + 1 | 0)
                ]);
      } else {
        return /* record */Block.record([
                  "metas",
                  "warnings",
                  "errors"
                ], [
                  shitpile.slice(0, indexOfWarnings),
                  shitpile.slice(indexOfWarnings + 1 | 0),
                  []
                ]);
      }
    } else if (hasErrors) {
      return /* record */Block.record([
                "metas",
                "warnings",
                "errors"
              ], [
                shitpile.slice(0, indexOfErrors),
                [],
                shitpile.slice(indexOfErrors + 1 | 0)
              ]);
    } else {
      return /* record */Block.record([
                "metas",
                "warnings",
                "errors"
              ], [
                shitpile,
                [],
                []
              ]);
    }
  } else if (hasWarnings) {
    if (hasErrors) {
      return /* record */Block.record([
                "metas",
                "warnings",
                "errors"
              ], [
                [],
                shitpile.slice(0, indexOfErrors),
                shitpile.slice(indexOfErrors + 1 | 0)
              ]);
    } else {
      return /* record */Block.record([
                "metas",
                "warnings",
                "errors"
              ], [
                [],
                shitpile,
                []
              ]);
    }
  } else if (hasErrors) {
    return /* record */Block.record([
              "metas",
              "warnings",
              "errors"
            ], [
              [],
              [],
              shitpile
            ]);
  } else {
    return /* record */Block.record([
              "metas",
              "warnings",
              "errors"
            ], [
              [],
              [],
              []
            ]);
  }
}

var filepath = /* String */Block.variant("String", 1, [(function (raw) {
        var parsed = Path.parse(raw.replace("\n", ""));
        var joined = $$String.concat("/", $$Array.to_list(Path.join(parsed.dir, parsed.base).split(Path.sep)));
        if (joined.charCodeAt(0) === 8234.0) {
          return Js_option.some(joined.slice(1).trim());
        } else {
          return Js_option.some(joined.trim());
        }
      })]);

var expr = /* String */Block.variant("String", 1, [(function (raw) {
        var tokens = raw.trim().split((/(\?\d+)|(\_\d+[^\}\)\s]*)/));
        return Js_option.some(tokens.map((function (token, i) {
                          var match = i % 3;
                          if (match !== 1) {
                            if (match !== 2) {
                              return /* Plain */Block.variant("Plain", 0, [token]);
                            } else {
                              return /* Underscore */Block.variant("Underscore", 2, [token]);
                            }
                          } else {
                            return /* QuestionMark */Block.variant("QuestionMark", 1, [token]);
                          }
                        })));
      })]);

var ofType_000 = (/^([^\:]*) \: ((?:\n|.)+)/);

function ofType_001(captured) {
  return Util$AgdaMode.Option[/* bind */0]((function (type_) {
                return Util$AgdaMode.Option[/* bind */0]((function (term) {
                              return /* OfType */Block.variant("OfType", 0, [
                                        term,
                                        type_
                                      ]);
                            }), Util$AgdaMode.Parser[/* at */3](1, expr, captured));
              }), Util$AgdaMode.Parser[/* at */3](2, expr, captured));
}

var ofType = /* Regex */Block.variant("Regex", 0, [
    ofType_000,
    ofType_001
  ]);

var justType_000 = (/^Type ((?:\n|.)+)/);

function justType_001(captured) {
  return Util$AgdaMode.Option[/* map */1]((function (type_) {
                return /* JustType */Block.variant("JustType", 1, [type_]);
              }), Util$AgdaMode.Parser[/* at */3](1, expr, captured));
}

var justType = /* Regex */Block.variant("Regex", 0, [
    justType_000,
    justType_001
  ]);

var justSort_000 = (/^Sort ((?:\n|.)+)/);

function justSort_001(captured) {
  return Util$AgdaMode.Option[/* map */1]((function (sort) {
                return /* JustSort */Block.variant("JustSort", 2, [sort]);
              }), Util$AgdaMode.Parser[/* at */3](1, expr, captured));
}

var justSort = /* Regex */Block.variant("Regex", 0, [
    justSort_000,
    justSort_001
  ]);

var others = /* String */Block.variant("String", 1, [(function (raw) {
        return Util$AgdaMode.Option[/* map */1]((function (raw$prime) {
                      return /* Others */Block.variant("Others", 3, [raw$prime]);
                    }), Util$AgdaMode.Parser[/* parse */1](expr, raw));
      })]);

var OutputConstraint = /* module */Block.localModule([
    "ofType",
    "justType",
    "justSort",
    "others"
  ], [
    ofType,
    justType,
    justSort,
    others
  ]);

var outputConstraint = Util$AgdaMode.Parser[/* choice */4](/* array */[
      ofType,
      justType,
      justSort,
      others
    ]);

var interactionMeta = /* String */Block.variant("String", 1, [(function (raw) {
        return Util$AgdaMode.Option[/* map */1]((function (x) {
                      return /* InteractionMeta */Block.simpleVariant("InteractionMeta", [x]);
                    }), Util$AgdaMode.Parser[/* parse */1](outputConstraint, raw));
      })]);

var hiddenMeta_000 = (/((?:\n|.)*\S+)\s*\[ at (.+):(?:(\d+)\,(\d+)\-(\d+)\,(\d+)|(\d+)\,(\d+)\-(\d+)) \]/);

function hiddenMeta_001(captured) {
  return Util$AgdaMode.Option[/* bind */0]((function (raw) {
                var rowStart = Caml_format.caml_int_of_string(Js_option.getWithDefault(Js_option.getWithDefault("0", Caml_array.caml_array_get(captured, 7)), Caml_array.caml_array_get(captured, 3)));
                var rowEnd = Caml_format.caml_int_of_string(Js_option.getWithDefault(Js_option.getWithDefault("0", Caml_array.caml_array_get(captured, 7)), Caml_array.caml_array_get(captured, 5)));
                var colStart = Caml_format.caml_int_of_string(Js_option.getWithDefault(Js_option.getWithDefault("0", Caml_array.caml_array_get(captured, 8)), Caml_array.caml_array_get(captured, 4)));
                var colEnd = Caml_format.caml_int_of_string(Js_option.getWithDefault(Js_option.getWithDefault("0", Caml_array.caml_array_get(captured, 9)), Caml_array.caml_array_get(captured, 6)));
                var start = /* record */Block.record([
                    "pos",
                    "line",
                    "col"
                  ], [
                    undefined,
                    rowStart,
                    colStart
                  ]);
                var end_ = /* record */Block.record([
                    "pos",
                    "line",
                    "col"
                  ], [
                    undefined,
                    rowEnd,
                    colEnd
                  ]);
                return Util$AgdaMode.Option[/* map */1]((function (parsed) {
                              var path = Util$AgdaMode.Parser[/* at */3](2, filepath, captured);
                              return /* HiddenMeta */Block.simpleVariant("HiddenMeta", [
                                        parsed,
                                        /* Range */Block.simpleVariant("Range", [
                                            path,
                                            /* :: */Block.simpleVariant("::", [
                                                /* record */Block.record([
                                                    "start",
                                                    "end_"
                                                  ], [
                                                    start,
                                                    end_
                                                  ]),
                                                /* [] */0
                                              ])
                                          ])
                                      ]);
                            }), Util$AgdaMode.Parser[/* parse */1](outputConstraint, raw));
              }), Caml_array.caml_array_get(captured, 1));
}

var hiddenMeta = /* Regex */Block.variant("Regex", 0, [
    hiddenMeta_000,
    hiddenMeta_001
  ]);

function allGoalsWarnings(title, body) {
  var preprocessed = allGoalsWarningsPreprocess(title, body);
  var indexOfHiddenMetas = preprocessed[/* metas */0].findIndex((function (s) {
          return Js_option.isSome(Util$AgdaMode.Parser[/* parse */1](hiddenMeta, s));
        }));
  var interactionMetas = Util$AgdaMode.Parser[/* parseArray */2](interactionMeta, preprocessed[/* metas */0].slice(0, indexOfHiddenMetas));
  var hiddenMetas = Util$AgdaMode.Parser[/* parseArray */2](hiddenMeta, preprocessed[/* metas */0].slice(indexOfHiddenMetas));
  return /* record */Block.record([
            "interactionMetas",
            "hiddenMetas",
            "warnings",
            "errors"
          ], [
            interactionMetas,
            hiddenMetas,
            preprocessed[/* warnings */1],
            preprocessed[/* errors */2]
          ]);
}

function goalTypeContext(body) {
  var shitpile = unindent(body.split("\n"));
  var haveExists = shitpile.findIndex((function (s) {
          return Js_option.isSome(Js_primitive.null_to_opt(s.match((/^Have/))));
        })) !== -1;
  var indexOfDelimeter = shitpile.findIndex((function (s) {
          return Js_option.isSome(Js_primitive.null_to_opt(s.match((/\u2014{60}/g))));
        }));
  var goal = Util$AgdaMode.Option[/* map */1]((function (x) {
          return /* Goal */Block.simpleVariant("Goal", [x]);
        }), Util$AgdaMode.Parser[/* parse */1](expr, Caml_array.caml_array_get(shitpile, 0).slice(5)));
  var have = haveExists ? Util$AgdaMode.Option[/* map */1]((function (x) {
            return /* Have */Block.simpleVariant("Have", [x]);
          }), Util$AgdaMode.Parser[/* parse */1](expr, Caml_array.caml_array_get(shitpile, 1).slice(5))) : undefined;
  var interactionMetas = Util$AgdaMode.Parser[/* parseArray */2](interactionMeta, shitpile.slice(indexOfDelimeter + 1 | 0));
  var hiddenMetas = Util$AgdaMode.Parser[/* parseArray */2](hiddenMeta, shitpile.slice(indexOfDelimeter + 1 | 0));
  return /* record */Block.record([
            "goal",
            "have",
            "interactionMetas",
            "hiddenMetas"
          ], [
            goal,
            have,
            interactionMetas,
            hiddenMetas
          ]);
}

var Parser = /* module */Block.localModule([
    "unindent",
    "allGoalsWarningsPreprocess",
    "filepath",
    "expr",
    "OutputConstraint",
    "outputConstraint",
    "interactionMeta",
    "hiddenMeta",
    "allGoalsWarnings",
    "goalTypeContext"
  ], [
    unindent,
    allGoalsWarningsPreprocess,
    filepath,
    expr,
    OutputConstraint,
    outputConstraint,
    interactionMeta,
    hiddenMeta,
    allGoalsWarnings,
    goalTypeContext
  ]);

exports.Parser = Parser;
/* ofType Not a pure module */

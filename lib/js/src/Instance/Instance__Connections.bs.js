// Generated by BUCKLESCRIPT, PLEASE EDIT WITH CARE
'use strict';

var Curry = require("bs-platform/lib/js/curry.js");
var Rebase = require("@glennsl/rebase/lib/js/src/Rebase.bs.js");
var $$Promise = require("reason-promise/lib/js/src/js/promise.js");
var Parser$AgdaMode = require("../Parser.bs.js");
var Connection$AgdaMode = require("../Connection.bs.js");
var Caml_chrome_debugger = require("bs-platform/lib/js/caml_chrome_debugger.js");

function inquireAgdaPath(error, instance) {
  return $$Promise.mapError($$Promise.flatMap($$Promise.flatMap($$Promise.flatMap(Curry._1(instance.view.activate, undefined), (function (param) {
                            return Curry._1(instance.view.navigateSettings, /* Connection */1);
                          })), (function (param) {
                        return Curry._2(instance.view.updateConnection, undefined, error);
                      })), (function (param) {
                    return Curry._1(instance.view.inquireConnection, undefined);
                  })), (function (param) {
                return /* Cancelled */0;
              }));
}

function getAgdaPathAndArgs(instance) {
  var storedPath = Parser$AgdaMode.filepath(atom.config.get("agda-mode.agdaPath"));
  var storedArgs = Parser$AgdaMode.commandLineArgs(atom.config.get("agda-mode.agdaArgs"));
  if (!(Rebase.$$String.isEmpty(storedPath) || storedPath === ".")) {
    return $$Promise.resolved(/* Ok */Caml_chrome_debugger.variant("Ok", 0, [/* tuple */[
                    storedPath,
                    storedArgs
                  ]]));
  }
  var searchingFor = Rebase.$$String.trim(atom.config.get("agda-mode.agdaName"));
  return $$Promise.mapOk($$Promise.flatMapError(Connection$AgdaMode.autoSearch(searchingFor), (function (err) {
                    Curry._1(instance.onConnectionError.emit, err);
                    return inquireAgdaPath(err, instance);
                  })), (function (path) {
                return /* tuple */[
                        path,
                        []
                      ];
              }));
}

function persistConnection(instance, connection) {
  instance.connection = connection;
  var path = Rebase.$$String.joinWith(" ", Rebase.List.fromArray(Rebase.$$Array.concat(connection.metadata.args, [connection.metadata.path])));
  atom.config.set("agda-mode.agdaPath", path);
  return $$Promise.map(Curry._2(instance.view.updateConnection, connection, undefined), (function (param) {
                return /* Ok */Caml_chrome_debugger.variant("Ok", 0, [connection]);
              }));
}

function connectWithAgdaPathAndArgs(instance, path, args) {
  var getMetadata = function (instance, path, args) {
    return $$Promise.flatMapError(Connection$AgdaMode.validateAndMake(path, args), (function (err) {
                  return $$Promise.flatMapOk(inquireAgdaPath(err, instance), (function (p) {
                                return getMetadata(instance, p, args);
                              }));
                }));
  };
  return $$Promise.mapOk($$Promise.flatMapOk($$Promise.mapOk(getMetadata(instance, path, args), Connection$AgdaMode.connect), (function (param) {
                    return persistConnection(instance, param);
                  })), Connection$AgdaMode.wire);
}

function connect(instance) {
  var connection = instance.connection;
  if (connection !== undefined) {
    return $$Promise.resolved(/* Ok */Caml_chrome_debugger.variant("Ok", 0, [connection]));
  } else {
    return $$Promise.flatMapOk(getAgdaPathAndArgs(instance), (function (param) {
                  return connectWithAgdaPathAndArgs(instance, param[0], param[1]);
                }));
  }
}

function disconnect(instance) {
  var connection = instance.connection;
  if (connection !== undefined) {
    Connection$AgdaMode.disconnect(/* DisconnectedByUser */0, connection);
    instance.connection = undefined;
    return Curry._2(instance.view.updateConnection, undefined, undefined);
  } else {
    return $$Promise.resolved(undefined);
  }
}

exports.inquireAgdaPath = inquireAgdaPath;
exports.getAgdaPathAndArgs = getAgdaPathAndArgs;
exports.persistConnection = persistConnection;
exports.connectWithAgdaPathAndArgs = connectWithAgdaPathAndArgs;
exports.connect = connect;
exports.disconnect = disconnect;
/* Promise Not a pure module */

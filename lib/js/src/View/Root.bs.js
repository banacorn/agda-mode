// Generated by BUCKLESCRIPT VERSION 5.0.6, PLEASE EDIT WITH CARE
'use strict';

var Curry = require("bs-platform/lib/js/curry.js");
var React = require("react");
var Rebase = require("@glennsl/rebase/lib/js/src/Rebase.bs.js");
var ReactDom = require("react-dom");
var Caml_option = require("bs-platform/lib/js/caml_option.js");
var Tab$AgdaMode = require("./Tab.bs.js");
var Hook$AgdaMode = require("./Hook.bs.js");
var View$AgdaMode = require("../View.bs.js");
var Async$AgdaMode = require("../Util/Async.bs.js");
var Event$AgdaMode = require("../Util/Event.bs.js");
var Panel$AgdaMode = require("./Panel/Panel.bs.js");
var Editors$AgdaMode = require("../Editors.bs.js");
var Channels$AgdaMode = require("../Channels.bs.js");
var Settings$AgdaMode = require("./Settings/Settings.bs.js");
var Type__View$AgdaMode = require("../Type/Type__View.bs.js");
var Caml_chrome_debugger = require("bs-platform/lib/js/caml_chrome_debugger.js");
var Webapi__Dom__HtmlElement = require("bs-webapi/lib/js/src/Webapi/Webapi__Dom/Webapi__Dom__HtmlElement.js");

function getBottomPanelContainer(param) {
  var partial_arg = Rebase.$$Array[/* filterMap */23];
  var containers = Rebase.$$Array[/* filter */10]((function (elem) {
          return elem.className === "agda-mode-panel-container";
        }), Rebase.$$Array[/* flatMap */5](Curry._2(Rebase.Fn[/* >> */6], Curry._2(Rebase.Fn[/* >> */6], (function (prim) {
                      return prim.childNodes;
                    }), (function (prim) {
                      return Array.prototype.slice.call(prim);
                    })), (function (param) {
                  return partial_arg(Webapi__Dom__HtmlElement.ofNode, param);
                })), Rebase.$$Array[/* map */0]((function (prim) {
                  return atom.views.getView(prim);
                }), atom.workspace.getBottomPanels())));
  var match = Rebase.$$Array[/* get */17](containers, 0);
  if (match !== undefined) {
    return Caml_option.valFromOption(match);
  } else {
    var panelContainer = document.createElement("article");
    panelContainer.classList.add("agda-mode-panel-container");
    atom.workspace.addBottomPanel({
          item: panelContainer,
          priority: 0,
          visible: true
        });
    return panelContainer;
  }
}

function getPanelContainerFromMountingPoint(param) {
  if (param.tag) {
    return param[0][/* element */0];
  } else {
    return param[0];
  }
}

function Root(Props) {
  var editors = Props.editors;
  var handles = Props.handles;
  var channels = Props.channels;
  var match = Hook$AgdaMode.useState(false);
  var setSettingsActivation = match[1];
  var settingsActivated = match[0];
  var match$1 = Hook$AgdaMode.useState(undefined);
  var setSettingsView = match$1[1];
  var settingsView = match$1[0];
  var match$2 = Hook$AgdaMode.useState(/* tuple */[
        undefined,
        undefined
      ]);
  var match$3 = match$2[0];
  Hook$AgdaMode.useEventListener(setSettingsActivation, handles[/* activateSettingsView */4]);
  Hook$AgdaMode.useEventListener(match$2[1], handles[/* updateConnection */1]);
  React.useEffect((function () {
          if (settingsView !== undefined) {
            if (settingsActivated) {
              Event$AgdaMode.emitOk(true, handles[/* onSettingsView */5]);
              return undefined;
            } else {
              Curry._1(settingsView[/* kill */1], /* () */0);
              Curry._1(setSettingsView, undefined);
              Event$AgdaMode.emitOk(false, handles[/* onSettingsView */5]);
              return undefined;
            }
          } else if (settingsActivated) {
            var tab = Tab$AgdaMode.make(editors[/* source */1], (function (param) {
                    return "[Settings] " + editors[/* source */1].getTitle();
                  }), "settings", (function (param, param$1, param$2) {
                    return Event$AgdaMode.emitOk(true, handles[/* onSettingsView */5]);
                  }), undefined, (function (param) {
                    Curry._1(setSettingsActivation, false);
                    return Event$AgdaMode.emitOk(false, handles[/* onSettingsView */5]);
                  }), undefined, /* () */0);
            Curry._1(setSettingsView, tab);
            return undefined;
          } else {
            return undefined;
          }
        }), /* array */[settingsActivated]);
  var match$4 = Hook$AgdaMode.useState(/* Bottom */Caml_chrome_debugger.variant("Bottom", 0, [getBottomPanelContainer(/* () */0)]));
  var setMountingPoint = match$4[1];
  var mountingPoint = match$4[0];
  var mountingPointRef = React.useRef(mountingPoint);
  mountingPointRef.current = mountingPoint;
  var queryRef = React.useRef(undefined);
  React.useEffect((function () {
          editors[/* query */2] = queryRef.current;
          return undefined;
        }), /* array */[mountingPoint]);
  var mountPanel = function (editors$1, mountingTarget) {
    var createTab = function (param) {
      return Tab$AgdaMode.make(editors$1[/* source */1], (function (param) {
                    return "[Agda Mode] " + editors$1[/* source */1].getTitle();
                  }), "panel", (function (param, param$1, previousItem) {
                    return Rebase.$$Option[/* forEach */8]((function (pane) {
                                  pane.activate();
                                  pane.activateItem(previousItem);
                                  return /* () */0;
                                }), atom.workspace.paneForItem(previousItem));
                  }), undefined, (function (param) {
                    return mountPanel(editors, /* AtBottom */0);
                  }), undefined, /* () */0);
    };
    var match = mountingPointRef.current;
    if (match.tag) {
      if (mountingTarget) {
        return /* () */0;
      } else {
        Curry._1(match[0][/* kill */1], /* () */0);
        return Curry._1(setMountingPoint, /* Bottom */Caml_chrome_debugger.variant("Bottom", 0, [getBottomPanelContainer(/* () */0)]));
      }
    } else if (mountingTarget) {
      return Curry._1(setMountingPoint, /* Pane */Caml_chrome_debugger.variant("Pane", 1, [createTab(/* () */0)]));
    } else {
      return /* () */0;
    }
  };
  Hook$AgdaMode.useChannel((function (param) {
          var match = mountingPointRef.current;
          if (match.tag) {
            mountPanel(editors, /* AtBottom */0);
          } else {
            mountPanel(editors, /* AtPane */1);
          }
          return Async$AgdaMode.resolve(/* () */0);
        }), channels[/* toggleDocking */2]);
  var match$5 = Hook$AgdaMode.useState(false);
  var setActivation = match$5[1];
  var activated = match$5[0];
  React.useEffect((function () {
          if (activated) {
            if (mountingPoint.tag) {
              Curry._1(mountingPoint[0][/* activate */2], /* () */0);
            }
            
          }
          return undefined;
        }), /* array */[activated]);
  Hook$AgdaMode.useChannel((function (param) {
          Curry._1(setActivation, true);
          return Async$AgdaMode.resolve(getPanelContainerFromMountingPoint(mountingPointRef.current));
        }), channels[/* activatePanel */0]);
  Hook$AgdaMode.useChannel((function (param) {
          Curry._1(setActivation, false);
          return Async$AgdaMode.resolve(/* () */0);
        }), channels[/* deactivatePanel */1]);
  var match$6 = React.useReducer(Type__View$AgdaMode.Debug[/* reducer */0], Type__View$AgdaMode.Debug[/* initialState */1]);
  var match$7 = Hook$AgdaMode.useState(/* record */Caml_chrome_debugger.record([
          "text",
          "style"
        ], [
          "",
          0
        ]));
  var setHeader = match$7[1];
  var match$8 = Hook$AgdaMode.useState(/* Nothing */0);
  var setBody = match$8[1];
  var match$9 = Hook$AgdaMode.useState(/* Display */0);
  var setMode = match$9[1];
  var panelRef = React.useRef(null);
  Hook$AgdaMode.useChannel((function (param) {
          Curry._1(setMode, /* Display */0);
          Curry._1(setHeader, param[0]);
          Curry._1(setBody, param[1]);
          return Async$AgdaMode.resolve(/* () */0);
        }), channels[/* display */3]);
  Hook$AgdaMode.useChannel((function (param) {
          Curry._1(setActivation, true);
          Curry._1(setMode, /* Inquire */1);
          Editors$AgdaMode.Focus[/* on */1](/* Query */1, editors);
          Curry._1(setHeader, param[0]);
          return Async$AgdaMode.pass((function (param) {
                          Curry._1(setMode, /* Display */0);
                          return Editors$AgdaMode.Focus[/* on */1](/* Source */0, editors);
                        }))(Event$AgdaMode.once(handles[/* onInquire */0]));
        }), channels[/* inquire */4]);
  Hook$AgdaMode.useChannel((function (param) {
          var mountingPoint = mountingPointRef.current;
          if (mountingPoint.tag) {
            Curry._1(mountingPoint[0][/* kill */1], /* () */0);
          } else {
            var panel = panelRef.current;
            if (!(panel == null)) {
              mountingPoint[0].removeChild(panel);
            }
            
          }
          return Async$AgdaMode.resolve(/* () */0);
        }), handles[/* destroy */7]);
  var containerElement = getPanelContainerFromMountingPoint(mountingPoint);
  var settingsElement = settingsView !== undefined ? Caml_option.some(settingsView[/* element */0]) : undefined;
  var hidden;
  hidden = mountingPoint.tag ? false : !activated;
  return React.createElement(React.Fragment, undefined, React.createElement(Channels$AgdaMode.Provider[/* make */0], {
                  value: channels,
                  children: React.createElement(Type__View$AgdaMode.Mouse[/* Provider */1][/* make */0], {
                        value: (function ($$event) {
                            return Event$AgdaMode.emitOk($$event, handles[/* onMouseEvent */9]);
                          }),
                        children: React.createElement(Type__View$AgdaMode.Debug[/* Provider */3][/* make */0], {
                              value: match$6[1],
                              children: null
                            }, React.createElement(Panel$AgdaMode.make, {
                                  editors: editors,
                                  containerElement: containerElement,
                                  onMountingTargetChange: (function (param) {
                                      if (param) {
                                        return mountPanel(editors, /* AtPane */1);
                                      } else {
                                        return mountPanel(editors, /* AtBottom */0);
                                      }
                                    }),
                                  body: match$8[0],
                                  header: match$7[0],
                                  mountingPoint: mountingPoint,
                                  mode: match$9[0],
                                  hidden: hidden,
                                  settingsView: settingsView,
                                  activated: activated,
                                  panelRef: panelRef,
                                  onInquireQuery: handles[/* onInquire */0],
                                  onQueryEditorRef: (function (ref) {
                                      queryRef.current = Caml_option.some(ref);
                                      return /* () */0;
                                    }),
                                  editorPlaceholder: "",
                                  editorValue: "",
                                  onInputMethodChange: handles[/* onInputMethodChange */8],
                                  onSettingsViewToggle: setSettingsActivation
                                }), React.createElement(Settings$AgdaMode.make, {
                                  inquireConnection: handles[/* inquireConnection */2],
                                  onInquireConnection: handles[/* onInquireConnection */3],
                                  connection: match$3[0],
                                  connectionError: match$3[1],
                                  navigate: handles[/* navigateSettingsView */6],
                                  debug: match$6[0],
                                  element: settingsElement
                                }))
                      })
                }));
}

function initialize(editors) {
  var element = document.createElement("article");
  var handles = View$AgdaMode.makeHandles(/* () */0);
  var channels = Channels$AgdaMode.make(/* () */0);
  var view = View$AgdaMode.make(handles, channels);
  var component = React.createElement(Root, {
        editors: editors,
        handles: handles,
        channels: channels
      });
  ReactDom.render(component, element);
  return view;
}

var $$Event = 0;

var make = Root;

exports.$$Event = $$Event;
exports.getBottomPanelContainer = getBottomPanelContainer;
exports.getPanelContainerFromMountingPoint = getPanelContainerFromMountingPoint;
exports.make = make;
exports.initialize = initialize;
/* react Not a pure module */

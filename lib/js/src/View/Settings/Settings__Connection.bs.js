// Generated by BUCKLESCRIPT VERSION 5.0.6, PLEASE EDIT WITH CARE
'use strict';

var Curry = require("bs-platform/lib/js/curry.js");
var React = require("react");
var Rebase = require("@glennsl/rebase/lib/js/src/Rebase.bs.js");
var Caml_option = require("bs-platform/lib/js/caml_option.js");
var Hook$AgdaMode = require("../Hook.bs.js");
var Util$AgdaMode = require("../../Util.bs.js");
var Async$AgdaMode = require("../../Util/Async.bs.js");
var Event$AgdaMode = require("../../Util/Event.bs.js");
var Metadata$AgdaMode = require("../../Metadata.bs.js");
var Connection$AgdaMode = require("../../Connection.bs.js");
var MiniEditor$AgdaMode = require("../MiniEditor.bs.js");
var Settings__Connection__Error$AgdaMode = require("./Settings__Connection__Error.bs.js");

function Settings__Connection(Props) {
  var inquireConnection = Props.inquireConnection;
  var onInquireConnection = Props.onInquireConnection;
  var connection = Props.connection;
  var error = Props.error;
  var hidden = Props.hidden;
  var match = Hook$AgdaMode.useState(undefined);
  var setAutoSearchError = match[1];
  var autoSearchError = match[0];
  var match$1 = Hook$AgdaMode.useState("");
  var setConnectPath = match$1[1];
  var match$2 = Hook$AgdaMode.useState(undefined);
  var setEditorRef = match$2[1];
  var editorRef = match$2[0];
  var handleAutoSearch = function (param) {
    return Async$AgdaMode.finalError((function (err) {
                  return Curry._1(setAutoSearchError, err);
                }), Async$AgdaMode.thenOk((function (path) {
                        return Async$AgdaMode.resolve(editorRef !== undefined ? (Caml_option.valFromOption(editorRef).setText(path), /* () */0) : /* () */0);
                      }))(Connection$AgdaMode.autoSearch("agda")));
  };
  var handleConnect = function (path) {
    Curry._1(setConnectPath, path);
    Curry._1(setAutoSearchError, undefined);
    return Event$AgdaMode.emitOk(path, onInquireConnection);
  };
  React.useEffect((function () {
          return Event$AgdaMode.pipe(onInquireConnection, Event$AgdaMode.make(/* () */0));
        }), /* array */[]);
  React.useEffect((function () {
          return Event$AgdaMode.onOk((function (param) {
                          return Rebase.$$Option[/* forEach */8]((function (editor) {
                                        atom.views.getView(editor).focus();
                                        editor.selectAll();
                                        return /* () */0;
                                      }), editorRef);
                        }))(inquireConnection);
        }), /* array */[editorRef]);
  var connected = Rebase.$$Option[/* isSome */13](connection);
  var className = "agda-settings-connection" + (Util$AgdaMode.React[/* showWhen */5](!hidden) + Util$AgdaMode.React[/* when_ */4](!connected, "inquiring"));
  var status = connected ? React.createElement("span", {
          className: "icon icon-primitive-dot text-success",
          id: "connection-status",
          title: "connected"
        }) : React.createElement("span", {
          className: "icon icon-primitive-dot text-error",
          id: "connection-status",
          title: "disconnected"
        });
  var tmp;
  if (connection !== undefined) {
    var conn = connection;
    tmp = React.createElement(React.Fragment, undefined, React.createElement("p", undefined, "Path: " + conn[/* metadata */0][/* path */0]), React.createElement("p", undefined, "Version: " + conn[/* metadata */0][/* version */2]), React.createElement("p", undefined, "Supported protocol: " + Metadata$AgdaMode.Protocol[/* toString */0](conn[/* metadata */0][/* protocol */3])));
  } else {
    tmp = React.createElement(React.Fragment, undefined, React.createElement("p", undefined, "connection not established"));
  }
  return React.createElement("section", {
              className: className
            }, React.createElement("h1", undefined, React.createElement("span", {
                      className: "icon icon-plug"
                    }), React.createElement("span", undefined, "Connection to Agda"), status), React.createElement("hr", undefined), React.createElement("h2", undefined, "Status"), tmp, React.createElement("hr", undefined), React.createElement("h2", undefined, "Path"), React.createElement("p", undefined, React.createElement(MiniEditor$AgdaMode.make, {
                      value: connection !== undefined ? connection[/* metadata */0][/* path */0] : "",
                      placeholder: "path to Agda",
                      hidden: false,
                      onConfirm: handleConnect,
                      onEditorRef: (function (ref) {
                          return Curry._1(setEditorRef, Caml_option.some(ref));
                        })
                    })), React.createElement("p", undefined, React.createElement("button", {
                      className: "btn icon icon-search inline-block-tight",
                      onClick: handleAutoSearch
                    }, "auto search")), autoSearchError !== undefined ? React.createElement(Settings__Connection__Error$AgdaMode.make, {
                    error: autoSearchError
                  }) : (
                error !== undefined ? React.createElement(Settings__Connection__Error$AgdaMode.make, {
                        error: error
                      }) : null
              ));
}

var make = Settings__Connection;

exports.make = make;
/* react Not a pure module */

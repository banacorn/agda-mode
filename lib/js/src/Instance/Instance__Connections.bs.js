// Generated by BUCKLESCRIPT, PLEASE EDIT WITH CARE
'use strict';

var Curry = require("bs-platform/lib/js/curry.js");
var Rebase = require("@glennsl/rebase/lib/js/src/Rebase.bs.js");
var $$Promise = require("reason-promise/lib/js/src/js/promise.js");
var Parser$AgdaMode = require("../Parser.bs.js");
var Connection$AgdaMode = require("../Connection.bs.js");
var Caml_chrome_debugger = require("bs-platform/lib/js/caml_chrome_debugger.js");

function inquireAgdaPath(error, instance) {
  Curry._1(instance[/* view */2][/* activate */0], /* () */0);
  return $$Promise.flatMap(Curry._1(instance[/* view */2][/* navigateSettings */12], /* Connection */1), (function (param) {
                Curry._2(instance[/* view */2][/* updateConnection */13], undefined, error);
                return Curry._1(instance[/* view */2][/* inquireConnection */14], /* () */0);
              }));
}

function getAgdaPath(instance) {
  var storedPath = Parser$AgdaMode.filepath(atom.config.get("agda-mode.agdaPath"));
  var searchingFor = Rebase.$$String.trim(atom.config.get("agda-mode.agdaName"));
  var searchedPath = Rebase.$$String.isEmpty(storedPath) || storedPath === "." ? Connection$AgdaMode.autoSearch(searchingFor) : $$Promise.resolved(/* Ok */Caml_chrome_debugger.variant("Ok", 0, [storedPath]));
  return $$Promise.flatMapError(searchedPath, (function (err) {
                Curry._1(instance[/* onConnectionError */11][/* emit */1], err);
                return inquireAgdaPath(err, instance);
              }));
}

function persistConnection(instance, connection) {
  instance[/* connection */6] = connection;
  var path = Rebase.$$String.joinWith(" ", Rebase.List.fromArray(Rebase.$$Array.concat(connection[/* metadata */0][/* args */1], /* array */[connection[/* metadata */0][/* path */0]])));
  atom.config.set("agda-mode.agdaPath", path);
  Curry._2(instance[/* view */2][/* updateConnection */13], connection, undefined);
  return connection;
}

function connectWithAgdaPath(instance, path) {
  var getMetadata = function (instance, pathAndParams) {
    return $$Promise.flatMapError(Connection$AgdaMode.validateAndMake(pathAndParams), (function (err) {
                  return $$Promise.flatMapOk(inquireAgdaPath(err, instance), (function (param) {
                                return getMetadata(instance, param);
                              }));
                }));
  };
  return $$Promise.mapOk($$Promise.mapOk($$Promise.mapOk($$Promise.mapOk(getMetadata(instance, path), Connection$AgdaMode.connect), (function (param) {
                        return persistConnection(instance, param);
                      })), (function (param) {
                    var instance$1 = instance;
                    var connection = param;
                    Curry._1(connection[/* errorEmitter */3][/* on */3], (function (res) {
                            Curry._2(instance$1[/* handleResponse */8], instance$1, res);
                            return /* () */0;
                          }));
                    return connection;
                  })), Connection$AgdaMode.wire);
}

function connect(instance) {
  var match = instance[/* connection */6];
  if (match !== undefined) {
    return $$Promise.resolved(/* Ok */Caml_chrome_debugger.variant("Ok", 0, [match]));
  } else {
    return $$Promise.flatMapOk(getAgdaPath(instance), (function (param) {
                  return connectWithAgdaPath(instance, param);
                }));
  }
}

function disconnect(instance) {
  var match = instance[/* connection */6];
  if (match !== undefined) {
    Connection$AgdaMode.disconnect(/* DisconnectedByUser */0, match);
    instance[/* connection */6] = undefined;
    return Curry._2(instance[/* view */2][/* updateConnection */13], undefined, undefined);
  } else {
    return $$Promise.resolved(/* () */0);
  }
}

var get = connect;

var set = persistConnection;

exports.inquireAgdaPath = inquireAgdaPath;
exports.getAgdaPath = getAgdaPath;
exports.persistConnection = persistConnection;
exports.connectWithAgdaPath = connectWithAgdaPath;
exports.connect = connect;
exports.disconnect = disconnect;
exports.get = get;
exports.set = set;
/* Promise Not a pure module */

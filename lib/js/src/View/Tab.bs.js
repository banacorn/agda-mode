// Generated by BUCKLESCRIPT VERSION 5.0.3, PLEASE EDIT WITH CARE
'use strict';

var Atom = require("atom");
var Block = require("bs-platform/lib/js/block.js");
var Curry = require("bs-platform/lib/js/curry.js");
var Rebase = require("@glennsl/rebase/lib/js/src/Rebase.bs.js");
var Caml_option = require("bs-platform/lib/js/caml_option.js");
var Util$AgdaMode = require("../Util.bs.js");

function makeTabElement(param) {
  var element = document.createElement("article");
  element.classList.add("agda-mode");
  return element;
}

var itemOptions = {
  initialLine: 0,
  initialColumn: 0,
  split: "right",
  activatePane: true,
  activateItem: true,
  pending: false,
  searchAllPanes: true,
  location: undefined
};

function trigger(callback) {
  if (callback !== undefined) {
    return Curry._1(callback, /* () */0);
  } else {
    return /* () */0;
  }
}

function triggerArg(callback, arg) {
  if (callback !== undefined) {
    return Curry._1(callback, arg);
  } else {
    return /* () */0;
  }
}

function make(editor, getTitle, onOpen, onKill, onClose, onDidChangeActive, param) {
  var itemResource = Util$AgdaMode.Resource[/* make */0](/* () */0);
  var closedDeliberately = /* record */Block.record(["contents"], [false]);
  var subscriptions = new Atom.CompositeDisposable();
  var previousItem = atom.workspace.getActivePane().getActiveItem();
  var itemURI = "agda-mode://" + editor.getPath();
  var itemOpener = {
    element: makeTabElement(/* () */0),
    getTitle: getTitle
  };
  subscriptions.add(atom.workspace.addOpener((function (givenURI) {
              var match = givenURI === itemURI;
              if (match) {
                return Caml_option.some(itemOpener);
              }
              
            })));
  atom.workspace.open(itemURI, itemOptions).then((function (newItem) {
          Curry._1(itemResource[/* supply */1], newItem);
          if (onOpen !== undefined) {
            Curry._3(onOpen, itemOpener.element, newItem, previousItem);
          }
          var pane = atom.workspace.paneForItem(newItem);
          Rebase.$$Option[/* forEach */8]((function (pane$prime) {
                  subscriptions.add(pane$prime.onWillDestroyItem((function ($$event) {
                              var destroyedTitle = $$event.item.getTitle();
                              var getTitle = itemOpener.getTitle;
                              if (destroyedTitle === Curry._1(getTitle, /* () */0)) {
                                if (closedDeliberately[0]) {
                                  triggerArg(onKill, itemOpener.element);
                                } else {
                                  triggerArg(onClose, itemOpener.element);
                                }
                                subscriptions.dispose();
                                return /* () */0;
                              } else {
                                return 0;
                              }
                            })));
                  return /* () */0;
                }), pane);
          Rebase.$$Option[/* forEach */8]((function (pane$prime) {
                  subscriptions.add(pane$prime.onDidChangeActiveItem((function (item) {
                              var activatedTitle = item.getTitle();
                              var getTitle = itemOpener.getTitle;
                              if (activatedTitle === Curry._1(getTitle, /* () */0)) {
                                return triggerArg(onDidChangeActive, true);
                              } else {
                                return triggerArg(onDidChangeActive, false);
                              }
                            })));
                  return /* () */0;
                }), pane);
          return Promise.resolve(atom.workspace.getActivePane());
        }));
  return /* record */Block.record([
            "element",
            "kill",
            "activate"
          ], [
            itemOpener.element,
            (function (param) {
                Curry._1(itemResource[/* acquire */0], /* () */0).then((function (item) {
                        subscriptions.dispose();
                        closedDeliberately[0] = true;
                        Rebase.$$Option[/* forEach */8]((function (pane) {
                                pane.destroyItem(item);
                                return /* () */0;
                              }), atom.workspace.paneForItem(item));
                        return Promise.resolve(/* () */0);
                      }));
                return /* () */0;
              }),
            (function (param) {
                Curry._1(itemResource[/* acquire */0], /* () */0).then((function (item) {
                        Rebase.$$Option[/* forEach */8]((function (pane) {
                                pane.activateItem(item);
                                return /* () */0;
                              }), atom.workspace.paneForItem(item));
                        return Promise.resolve(/* () */0);
                      }));
                return /* () */0;
              })
          ]);
}

exports.makeTabElement = makeTabElement;
exports.itemOptions = itemOptions;
exports.trigger = trigger;
exports.triggerArg = triggerArg;
exports.make = make;
/* atom Not a pure module */
